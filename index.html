<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300..1000&display=swap" rel="stylesheet" />
  <script defer src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
  <title>بوابة الترفيه — مطوّرة بخط كايرو</title>
  <!-- Open Graph for better sharing -->
  <meta property="og:title" content="بوابة الترفيه — مشاهدة ومسلسلات ووسائط" />
  <meta property="og:description" content="مشغّل متقدّم، ترجمة SRT/VTT، تشغيل الحلقة التالية، وتصنيفات مرنة." />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://dummyimage.com/1200x630/0b1220/22d3ee.png&text=%D8%A8%D9%88%D8%A7%D8%A8%D8%A9+%D8%A7%D9%84%D8%AA%D8%B1%D9%81%D9%8A%D9%87" />
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#94a3b8;--txt:#e5e7eb;--acc:#22d3ee;--acc2:#a78bfa;--danger:#ef4444}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--txt);font-family:'Cairo',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans Arabic",Tahoma,Arial,sans-serif}
    a{color:inherit;text-decoration:none}
    .container{max-width:1220px;margin:0 auto;padding:18px}

    header{position:sticky;top:0;background:rgba(15,23,42,.85);backdrop-filter:blur(10px);z-index:10;border-bottom:1px solid #1f2937;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    nav{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .brand{font-weight:900;letter-spacing:.4px}
    .brand span{color:var(--acc)}

    .tabs{display:flex;gap:10px;flex-wrap:wrap}
    .tab{padding:.65rem 1.05rem;border:1px solid #1f2937;border-radius:14px;background:#0b1220;transition:.2s;position:relative;overflow:hidden}
    .tab:hover{border-color:#374151}
    .tab.active{background:linear-gradient(135deg,#0b1220,#111827)}
    .tab::after{content:"";position:absolute;inset:auto 12px -1px 12px;height:2px;background:linear-gradient(90deg,var(--acc),var(--acc2));opacity:0;transform:scaleX(.3);transition:.25s}
    .tab:hover::after,.tab.active::after{opacity:1;transform:scaleX(1)}

    .page{display:none}
    .page.active{display:block}

    .section{background:rgba(17,24,39,.65);border:1px solid #1f2937;border-radius:18px;padding:18px;margin:18px 0;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:18px;flex-wrap:wrap}
    .col{flex:1 1 340px}

    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;overflow:hidden;display:flex;flex-direction:column;transition:transform .18s ease, box-shadow .18s ease}
    .card:hover{transform:translateY(-4px);box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .card img{width:100%;aspect-ratio:16/9;object-fit:cover;height:auto}
    .card .p{padding:.85rem;display:flex;flex-direction:column;gap:.35rem}

    button,.btn{cursor:pointer;border:1px solid #1f2937;background:#0b1220;color:var(--txt);padding:.6rem 1rem;border-radius:12px;transition:.15s}
    .btn-acc{background:linear-gradient(135deg, #0ea5e9, #22d3ee);color:#001018;border:none}
    .btn-danger{background:linear-gradient(135deg,#ef4444,#f97316);color:#220000;border:none}
    input[type="text"],input[type="url"],input[type="search"],input[type="range"],select{width:100%;padding:.7rem .9rem;border-radius:12px;border:1px solid #1f2937;background:#0b1220;color:var(--txt)}
    .pill{padding:.3rem .7rem;border:1px solid #1f2937;border-radius:999px;font-size:.9rem;color:var(--muted)}
    .muted{color:var(--muted)}

    /* Dropzone */
    .dropzone{display:flex;align-items:center;justify-content:center;min-height:90px;border:2px dashed #334155;border-radius:14px;background:#0b1220;color:var(--muted)}
    .dropzone.drag{border-color:var(--acc);box-shadow:0 0 0 3px #22d3ee33 inset}

    /* Back to top */
    .back-top{position:fixed;bottom:20px;inset-inline-end:20px;z-index:50;border-radius:999px;padding:.7rem .9rem;font-weight:700;border:none;background:linear-gradient(135deg,#22d3ee,#a78bfa);color:#061015;box-shadow:0 12px 30px rgba(0,0,0,.35);transform:scale(0);opacity:0;transition:.2s}
    .back-top.show{transform:scale(1);opacity:1}

    /* خلفية متحركة ناعمة */
    .bg-blobs{position:fixed;inset:0;pointer-events:none;z-index:-1;overflow:hidden}
    .blob{position:absolute;filter:blur(55px);opacity:.35;border-radius:50%;animation:float 18s ease-in-out infinite}
    .b1{width:520px;height:520px;background:radial-gradient(circle at 30% 30%, #22d3ee, transparent 60%);top:-120px;left:-140px}
    .b2{width:460px;height:460px;background:radial-gradient(circle at 70% 30%, #a78bfa, transparent 60%);right:-160px;top:-80px;animation-delay:-6s}
    .b3{width:520px;height:520px;background:radial-gradient(circle at 50% 70%, #34d399, transparent 60%);bottom:-180px;left:50%;transform:translateX(-50%);animation-delay:-12s}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-25px)}}

    /* شاشة عرض التصنيفات (لو حبيت تضيفها هنا لاحقًا) */
    .player-wrap{width:100%;max-width:900px;background:#000;border-radius:16px;border:1px solid #1f2937;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .player-controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-top:10px}
    .label{font-size:.9rem;color:var(--muted)}
      /* أفلام/مسلسلات */
    .hero{position:relative;border-radius:18px;overflow:hidden;min-height:220px;display:flex;align-items:flex-end;padding:18px;background:linear-gradient(160deg,#0b1220,#0f172a);border:1px solid #1f2937}
    .hero::before{content:"";position:absolute;inset:0;background-size:cover;background-position:center;opacity:.25;filter:blur(2px)}
    .hero .title{position:relative;font-weight:900}
    .hero .controls{position:relative;margin-inline-start:auto;display:flex;gap:8px;flex-wrap:wrap}
    .filters{display:flex;gap:8px;flex-wrap:wrap}
    .h-scroll{display:grid;grid-auto-flow:column;grid-auto-columns:180px;gap:12px;overflow-x:auto;scroll-snap-type:x mandatory;padding-bottom:6px}
    .h-scroll .card{scroll-snap-align:start}
    .progress{height:6px;background:#1f2937;border-radius:999px;overflow:hidden}
    .progress>span{display:block;height:100%;background:linear-gradient(90deg,var(--acc),var(--acc2))}
    [data-cat="horror"] .hero::before{background-image:radial-gradient(800px 300px at 60% -80px,#ef444422,transparent),radial-gradient(600px 240px at -10% 120%,#a78bfa22,transparent)}
    [data-cat="action"] .hero::before{background-image:radial-gradient(800px 300px at 60% -80px,#f59e0b33,transparent),radial-gradient(600px 240px at -10% 120%,#10b98122,transparent)}
    [data-cat="foreign"] .hero::before{background-image:radial-gradient(700px 260px at 40% -80px,#22d3ee22,transparent)}
    [data-cat="egypt"] .hero::before{background-image:radial-gradient(700px 260px at 40% -80px,#e11d4822,transparent)}
    [data-cat="arab-series"] .hero::before{background-image:radial-gradient(700px 260px at 40% -80px,#22c55e22,transparent)}
    [data-cat="anime"] .hero::before{background-image:radial-gradient(700px 260px at 40% -80px,#a78bfa33,transparent)}
      /* تيم فاتح لإمكانية الوصول */
    body[data-theme="light"]{--bg:#f7f7fb;--card:#ffffff;--muted:#475569;--txt:#0b1220;}
    body[data-theme="light"] header{background:rgba(255,255,255,.85)}

    .prefs{display:flex;gap:8px;align-items:center}
    .prefs .pill{cursor:pointer}

    /* Skeleton */
    .skeleton{position:relative;background:linear-gradient(90deg,#1f2937 25%,#263042 37%,#1f2937 63%);background-size:400% 100%;animation:skeleton 1.2s ease-in-out infinite}
    @keyframes skeleton{0%{background-position:100% 50%}100%{background-position:0 50%}}

    /* نافذة التالي */
    .next-overlay{position:relative}
    .next-box{position:absolute;inset:auto 16px 16px auto;display:none;min-width:280px;background:#0b1220dd;border:1px solid #1f2937;border-radius:12px;padding:12px;box-shadow:0 12px 30px rgba(0,0,0,.35)}
    .next-box.show{display:block}
    .next-title{font-weight:700;margin-bottom:6px}

    /* قائمة الترجمة */
    .sub-select{min-width:140px}
  </style>
</head>
<body>
  <div class="bg-blobs"><span class="blob b1"></span><span class="blob b2"></span><span class="blob b3"></span></div>

  <header>
    <div class="container">
      <nav>
        <div class="brand">🎬 <span>الترفيه</span> — بوابة الويب</div>
        <div class="tabs" role="tablist">
          <a href="#/media" class="tab" data-tab="media">الوسائط</a>
          <a href="#/movies" class="tab" data-tab="movies">مسلسلات وأفلام</a>
          <a href="#/fun" class="tab" data-tab="fun">الترفيه</a>
          <div class="prefs">
            <button id="themeToggle" class="pill" title="تبديل الثيم">🌙/☀️</button>
            <span class="pill" title="تكبير/تصغير الخط">حجم الخط: <button id="fontMinus" class="pill" style="margin-inline:6px">A−</button><button id="fontPlus" class="pill">A+</button></span>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- صفحة الوسائط (مطوّرة) -->
    <section id="page-media" class="page active">
      <h2>🎵 الوسائط</h2>

      <!-- AUDIO -->
      <div class="section">
        <h3>مشغل الموسيقى — متقدّم</h3>
        <div class="row">
          <div class="col">
            <audio id="audio" controls style="width:100%;max-width:100%"></audio>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
              <button id="aPrev">⏮️ السابق</button>
              <button id="aPlay">▶️ تشغيل</button>
              <button id="aPause">⏸️ إيقاف مؤقت</button>
              <button id="aNext">⏭️ التالي</button>
              <button id="aShuffle" class="pill">🔀 عشوائي: إيقاف</button>
              <button id="aRepeat" class="pill">🔁 تكرار: لا</button>
              <button id="aAutoplay" class="pill">🔄 تلقائي: تشغيل</button>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px">
              <span class="label">التقدم:</span>
              <input id="aSeek" type="range" min="0" value="0" style="flex:1 1 220px" />
              <span id="aCur" class="pill">0:00</span>
              <span id="aDur" class="pill">0:00</span>
              <span class="label">الصوت:</span>
              <input id="aVol" type="range" min="0" max="1" step="0.01" value="1" style="width:140px" />
              <button id="aMute" class="pill">🔈 كتم</button>
              <label class="pill">السرعة
                <select id="aRate" style="width:auto;margin-inline-start:6px"><option>0.75</option><option selected>1</option><option>1.25</option><option>1.5</option><option>2</option></select>
              </label>
            </div>
            <div class="muted" id="aNow" style="margin-top:6px">لا يوجد ملف مُشغّل</div>
          </div>
          <div class="col">
            <label class="btn-acc btn">📥 أضِف ملفات صوت (متعدد)
              <input id="aFiles" type="file" accept="audio/*" multiple hidden />
            </label>
            <div id="aDrop" class="dropzone" style="margin-top:8px">اسحب وأفلِت ملفات الصوت هنا</div>
            <div class="section" id="aList" style="max-height:280px;overflow:auto;margin-top:8px"></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
              <button id="aClear" class="btn">مسح القائمة</button>
              <button id="aExport" class="btn">تصدير أسماء</button>
              <label class="btn">استيراد <input id="aImport" type="file" accept="application/json" hidden></label>
            </div>
          </div>
        </div>
      </div>

      <!-- VIDEO -->
      <div class="section">
        <h3>مشغل الفيديو — متقدّم</h3>
        <div class="row">
          <div class="col">
            <video id="video" controls style="width:100%;max-height:360px;background:#000;border-radius:12px"></video>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
              <button id="vPrev">⏮️ السابق</button>
              <button id="vPlay">▶️ تشغيل</button>
              <button id="vPause">⏸️ إيقاف مؤقت</button>
              <button id="vNext">⏭️ التالي</button>
              <button id="vShuffle" class="pill">🔀 عشوائي: إيقاف</button>
              <button id="vRepeat" class="pill">🔁 تكرار: لا</button>
              <button id="vAutoplay" class="pill">🔄 تلقائي: تشغيل</button>
              <button id="vPiP" class="pill">🗔 PiP</button>
              <button id="vShot" class="pill">📸 لقطة</button>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:8px">
              <span class="label">التقدم:</span>
              <input id="vSeek" type="range" min="0" value="0" style="flex:1 1 220px" />
              <span id="vCur" class="pill">0:00</span>
              <span id="vDur" class="pill">0:00</span>
              <span class="label">الصوت:</span>
              <input id="vVol" type="range" min="0" max="1" step="0.01" value="1" style="width:140px" />
              <button id="vMute" class="pill">🔈 كتم</button>
              <label class="pill">السرعة
                <select id="vRate" style="width:auto;margin-inline-start:6px"><option>0.75</option><option selected>1</option><option>1.25</option><option>1.5</option><option>2</option></select>
              </label>
            </div>
            <div class="muted" id="vNow" style="margin-top:6px">لا يوجد ملف مُشغّل</div>
          </div>
          <div class="col">
            <label class="btn-acc btn">📥 أضِف ملفات فيديو (متعدد)
              <input id="vFiles" type="file" accept="video/*" multiple hidden />
            </label>
            <div id="vDrop" class="dropzone" style="margin-top:8px">اسحب وأفلِت ملفات الفيديو هنا</div>
            <div class="section" id="vList" style="max-height:280px;overflow:auto;margin-top:8px"></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
              <button id="vClear" class="btn">مسح القائمة</button>
              <button id="vExport" class="btn">تصدير أسماء</button>
              <label class="btn">استيراد <input id="vImport" type="file" accept="application/json" hidden></label>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- مسلسلات وأفلام -->
    <section id="page-movies" class="page">
      <h2>🎞️ مسلسلات وأفلام</h2>
      <!-- الصفحة الرئيسية للتصنيفات -->
      <div id="movies-home" class="section">
        <h3>التصنيفات</h3>
        <div class="cards" style="grid-template-columns:repeat(auto-fill,minmax(160px,1fr))">
          <a class="btn" href="#/movies/egypt">أفلام مصرية</a>
          <a class="btn" href="#/movies/horror">أفلام رعب</a>
          <a class="btn" href="#/movies/foreign">أفلام أجنبي</a>
          <a class="btn" href="#/movies/action">أفلام أكشن</a>
          <a class="btn" href="#/movies/arab-series">مسلسلات عربية وخليجية</a>
          <a class="btn" href="#/movies/anime">كرتون وأنمي</a>
        </div>
      </div>

      <!-- صفحة التصنيف مع المشغّل -->
      <div id="movies-cat" class="section" style="display:none" data-cat="">
        <div class="hero">
          <div class="title" id="catTitle">—</div>
          <div class="controls">
            <a class="btn" href="#/movies">⬅️ رجوع للتصنيفات</a>
            <button id="randomPlay" class="btn-acc">▶️ تشغيل عشوائي</button>
          </div>
        </div>

        <div class="player-wrap" style="margin-top:12px">
          <video id="mvVideo" controls playsinline></video>
          <iframe id="mvFrame" referrerpolicy="no-referrer" allowfullscreen sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
        </div>
        <div class="player-controls">
          <span class="label" id="mvTitle">—</span>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="mvPiP" class="pill">🗔 PiP</button>
            <button id="mvCast" class="pill">📡 Cast</button>
            <button id="mvFS" class="pill">⛶ ملء الشاشة</button>
            <button id="mvShare" class="pill">🔗 مشاركة</button>
            <label class="pill">السرعة
              <select id="mvRate" style="width:auto;margin-inline-start:6px">
                <option value="0.75">0.75x</option>
                <option value="1" selected>1x</option>
                <option value="1.25">1.25x</option>
                <option value="1.5">1.5x</option>
                <option value="2">2x</option>
              </select>
            </label>
            <label class="pill">الترجمة
              <select id="mvSubSel" class="sub-select" style="width:auto;margin-inline-start:6px">
                <option value="off">إيقاف</option>
              </select>
            </label>
          </div>
        </div>
        <div id="mvSubs" class="label" style="margin-top:6px"></div>
        <div class="next-overlay">
          <div id="mvNextBox" class="next-box">
            <div class="next-title">التالي بعد <span id="mvNextCount">5</span> ث</div>
            <div id="mvNextName" class="muted" style="margin-bottom:8px"></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button id="mvNextPlay" class="btn-acc">▶️ تشغيل الآن</button>
              <button id="mvNextCancel" class="btn">إلغاء</button>
            </div>
          </div>
        </div>

        <!-- تابع المشاهدة -->
        <div class="section" style="margin-top:12px">
          <h3 style="margin-top:0">تابع المشاهدة</h3>
          <div id="row-continue" class="h-scroll"></div>
        </div>

        <!-- الفلاتر -->
        <div class="section">
          <div class="filters">
            <input id="fSearch" type="search" placeholder="ابحث داخل التصنيف"/>
            <select id="fYear"><option value="">السنة</option><option>2025</option><option>2024</option><option>2023</option><option>2022</option><option>2021</option></select>
            <select id="fGenre"><option value="">النوع</option><option>Action</option><option>Horror</option><option>Drama</option><option>Comedy</option><option>Anime</option></select>
            <select id="fCountry"><option value="">البلد</option><option>EG</option><option>SA</option><option>US</option><option>UK</option><option>JP</option></select>
            <select id="fRating"><option value="">أدنى تقييم</option><option>9</option><option>8</option><option>7</option><option>6</option><option>5</option></select>
            <select id="fSort"><option value="new">الأحدث</option><option value="top">الأعلى تقييمًا</option><option value="views">الأكثر مشاهدة</option><option value="az">أ-ي</option></select>
          </div>
        </div>

        <!-- مكتبة التصنيف -->
        <div class="section">
          <h3 style="margin-top:0">مكتبة التصنيف</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
            <input id="newTitle" type="text" placeholder="العنوان" />
            <input id="newUrl" type="url" placeholder="رابط (mp4 أو YouTube/Vimeo/...)" />
            <input id="newPoster" type="url" placeholder="صورة بوستر (اختياري)" />
            <input id="newYear" type="text" placeholder="سنة" style="width:110px"/>
            <input id="newGenre" type="text" placeholder="النوع (فاصلة)" style="width:160px"/>
            <input id="newCountry" type="text" placeholder="بلد" style="width:110px"/>
            <input id="newRating" type="text" placeholder="تقييم 0-10" style="width:130px"/>
            <input id="newSeries" type="text" placeholder="اسم المسلسل (اختياري)" style="width:180px"/>
            <input id="newS" type="text" placeholder="S الموسم" style="width:100px"/>
            <input id="newE" type="text" placeholder="E الحلقة" style="width:100px"/>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
            <input id="newSubs" type="text" placeholder="ترجمات: url|lang ; url|lang (يدعم .srt/.vtt)"/>
            <button id="addItem" class="btn-acc">➕ إضافة</button>
            <button id="clearItems" class="btn-danger">🗑️ مسح الكل</button>
            <button id="exportItems" class="btn">⬇️ تصدير JSON</button>
            <label class="btn">⬆️ استيراد JSON <input id="importItems" type="file" accept="application/json" hidden></label>
          </div>
          <!-- TMDB Controls -->
          <div id="tmdbControls" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center">
            <input id="tmdbKey" type="text" placeholder="TMDB API Key" style="max-width:260px"/>
            <button id="tmdbSave" class="btn">حفظ TMDB</button>
            <button id="tmdbFetchNew" class="btn">جلب تلقائي (العنصر بالأعلى)</button>
            <span class="muted">— سيُستخدم لجلب الملصقات والوصف والتقييم تلقائيًا</span>
          </div>
          <!-- Cloud Sync (اختياري) -->
          <div id="cloudControls" class="section" style="margin:12px 0">
            <h4 style="margin:0 0 8px">☁️ مزامنة سحابية (اختياري)</h4>
            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <label class="pill">المزوّد
                <select id="syncProvider" style="width:auto;margin-inline-start:6px">
                  <option value="local">محلي فقط</option>
                  <option value="supabase">Supabase</option>
                </select>
              </label>
              <input id="supaUrl" type="url" placeholder="Supabase URL (https://xyz.supabase.co)" style="min-width:260px;display:none"/>
              <input id="supaKey" type="text" placeholder="Supabase anon key" style="min-width:260px;display:none"/>
              <input id="syncUser" type="text" placeholder="معرّف المستخدم (أي نص)" style="min-width:200px"/>
              <button id="syncPush" class="btn-acc">⬆️ رفع الحالة</button>
              <button id="syncPull" class="btn">⬇️ تحميل الحالة</button>
              <span id="syncStatus" class="muted"></span>
            </div>
            <div class="muted" style="margin-top:6px">يحفظ "المفضلة" و"تابع المشاهدة" لكل تصنيف. لـ Supabase تحتاج جدول <code>media_state</code> به أعمدة: <code>user_id (text, PK)</code>، <code>data (jsonb)</code>، <code>updated_at (timestamptz)</code>.</div>
          </div>
          <div id="grid" class="cards"></div>
        </div>
      </div>
    </section>

    <!-- الترفيه (Placeholder مختصر) -->
    <section id="page-fun" class="page">
      <h2>🕹️ الترفيه</h2>
      <div class="section">
        <h3>🔎 خانة بحث جوجل</h3>
        <form action="https://www.google.com/search" method="GET" target="_blank" style="display:flex;gap:12px;flex-wrap:wrap">
          <div class="col" style="flex:1 1 340px"><input type="search" name="q" placeholder="ابحث في جوجل..." autocomplete="on" /></div>
          <div class="col" style="flex:0 0 200px"><button class="btn-acc btn" type="submit">ابحث الآن</button></div>
        </form>
      </div>
      <div class="section">
        <h3>📱 وسائل التواصل</h3>
        <div class="cards">
          <a class="card" href="https://www.facebook.com" target="_blank" rel="noopener"><img src="data:image/svg+xml;utf8,<?xml version='1.0' ?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 72'><rect width='128' height='72' fill='%230b1220'/><g transform='translate(56,20)'><path d='M13 0h9v8h-6c-2 0-3 1-3 3v5h9l-1 8h-8v20h-9V24H0v-8h4v-4C4 4 8 0 13 0z' fill='%2338bdf8'/></g></svg>" alt="Facebook" /><div class="p"><strong>Facebook</strong><span class="muted">فيس بوك</span></div></a>
          <a class="card" href="https://twitter.com" target="_blank" rel="noopener"><img alt="Twitter" src="data:image/svg+xml;utf8,<?xml version='1.0' ?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 72'><rect width='128' height='72' fill='%230b1220'/><path d='M95 23c-3 1-6 2-9 2 3-2 5-5 6-8-3 2-7 3-10 4a13 13 0 0 0-22 12c-11 0-21-6-27-14-3 6-1 13 5 16-3 0-5-1-7-2 0 7 5 13 12 15-2 1-4 1-6 1l-3 0c4 5 10 8 17 8A37 37 0 0 1 31 61c7 4 15 6 24 6 29 0 45-24 45-45v-2c3-2 5-4 7-7-2 1-5 2-8 3z' fill='%230ea5e9'/></svg>"/><div class="p"><strong>Twitter / X</strong><span class="muted">تويتر</span></div></a>
          <a class="card" href="https://www.instagram.com" target="_blank" rel="noopener"><img alt="Instagram" src="data:image/svg+xml;utf8,<?xml version='1.0' ?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 72'><defs><linearGradient id='g' x1='0' x2='1'><stop offset='0' stop-color='%23f59e0b'/><stop offset='1' stop-color='%23a78bfa'/></linearGradient></defs><rect width='128' height='72' fill='%230b1220'/><g transform='translate(38,16)'><rect x='0' y='0' width='52' height='40' rx='12' fill='url(%23g)'/><circle cx='26' cy='20' r='10' fill='%23fff' opacity='.2'/><circle cx='40' cy='10' r='3' fill='%23fff' opacity='.7'/></g></svg>"/><div class="p"><strong>Instagram</strong><span class="muted">إنستجرام</span></div></a>
          <a class="card" href="https://www.youtube.com" target="_blank" rel="noopener"><img alt="YouTube" src="data:image/svg+xml;utf8,<?xml version='1.0' ?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 72'><rect width='128' height='72' fill='%230b1220'/><g transform='translate(24,16)'><rect x='0' y='0' width='80' height='40' rx='10' fill='%23ef4444'/><polygon points='28,8 28,32 52,20' fill='%23fff'/></g></svg>"/><div class="p"><strong>YouTube</strong><span class="muted">يوتيوب</span></div></a>
          <a class="card" href="https://www.likee.video/" target="_blank" rel="noopener"><img alt="Likee Live" src="data:image/svg+xml;utf8,<?xml version='1.0' ?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 72'><defs><linearGradient id='l' x1='0' x2='1'><stop offset='0' stop-color='%23fb7185'/><stop offset='1' stop-color='%23a78bfa'/></linearGradient></defs><rect width='128' height='72' fill='%230b1220'/><path d='M64 48c-8-6-20-12-20-22a10 10 0 0 1 18-6 10 10 0 0 1 18 6c0 10-12 16-16 22z' fill='url(%23l)'/></svg>"/><div class="p"><strong>Likee Live</strong><span class="muted">لايكي لايف</span></div></a>
          <a class="card" href="https://t.me" target="_blank" rel="noopener"><img alt="Telegram" src="data:image/svg+xml;utf8,<?xml version='1.0' ?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 72'><rect width='128' height='72' fill='%230b1220'/><path d='M20 36l88-26-18 56-28-20-16 14 2-20z' fill='%2338bdf8'/></svg>"/><div class="p"><strong>Telegram</strong><span class="muted">تليجرام</span></div></a>
          <a class="card" href="https://www.linkedin.com" target="_blank" rel="noopener"><img alt="LinkedIn" src="data:image/svg+xml;utf8,<?xml version='1.0' ?><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 72'><rect width='128' height='72' fill='%230b1220'/><g transform='translate(30,16)'><rect width='68' height='40' rx='6' fill='%230e7490'/><rect x='8' y='14' width='10' height='18' fill='%23fff'/><circle cx='13' cy='8' r='5' fill='%23fff'/><rect x='26' y='14' width='34' height='18' fill='%23fff' opacity='.9'/></g></svg>"/><div class="p"><strong>LinkedIn</strong><span class="muted">لينكدإن</span></div></a>
        </div>
      </div>
    </section>
  </main>

  <button id="backTop" class="back-top" aria-label="رجوع للأعلى">↑</button>

  <footer class="container"><div>© 2025 — جميع الحقوق محفوظه لى مؤسسه ذيب</div></footer>

  <script>
  // ===== Helpers =====
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  const formatTime = s => { s = Math.floor(s||0); const m = Math.floor(s/60), ss = String(s%60).padStart(2,'0'); return `${m}:${ss}`; };
  (() => { const yEl = document.getElementById('y'); if (yEl) yEl.textContent = new Date().getFullYear(); })();

  // ===== Router =====
  const routes = { '#/media': 'page-media', '#/movies': 'page-movies', '#/fun': 'page-fun' };
  function setActiveTab(hash){ $$('.tab').forEach(t=>t.classList.toggle('active', t.getAttribute('href')===hash)); }
  function showPageByHash(){
    const hash = location.hash || '#/media';
    Object.values(routes).forEach(id=>$('#'+id)?.classList.remove('active'));
    let pageId = routes['#/media'];
    if(routes[hash]) pageId = routes[hash];
    if(hash.startsWith('#/movies/')) pageId = 'page-movies';
    $('#'+pageId)?.classList.add('active');
    setActiveTab(pageId==='page-media'?'#/media':pageId==='page-movies'?'#/movies':'#/fun');
    if(pageId==='page-movies'){
      if(hash.startsWith('#/movies/')) openCat(hash.split('/')[2]); else closeCat();
    }
  }
  window.addEventListener('hashchange', showPageByHash);
  $$('.tabs a').forEach(a=> a.addEventListener('click', (e)=>{ e.preventDefault(); const h=a.getAttribute('href'); if(location.hash!==h){ location.hash=h; } else { showPageByHash(); } }));
  // تفويض عام لأي رابط يبدأ بـ #/ لضمان عمل الراوتر داخل الصفحات
  document.addEventListener('click',(e)=>{ const link=e.target.closest('a[href^="#/"]'); if(!link) return; e.preventDefault(); const h=link.getAttribute('href'); if(location.hash!==h){ location.hash=h; } else { showPageByHash(); } });

  // ===== Back to Top =====
  const backTop=$('#backTop');
  window.addEventListener('scroll',()=>{ if(window.scrollY>400){ backTop.classList.add('show'); } else { backTop.classList.remove('show'); } });
  backTop.addEventListener('click',()=>{ window.scrollTo({top:0, behavior:'smooth'}); });

  // ===== MEDIA: Audio =====
  const audio=$('#audio'), aFiles=$('#aFiles'), aList=$('#aList'), aNow=$('#aNow');
  const aSeek=$('#aSeek'), aCur=$('#aCur'), aDur=$('#aDur');
  const aVol=$('#aVol'), aMute=$('#aMute'), aRate=$('#aRate');
  const aDrop=$('#aDrop');
  let aLib=[], aIndex=-1, aShuffle=false, aRepeat='none', aAutoplay=true, aMuted=false;
  function renderAList(){ aList.innerHTML=''; if(aLib.length===0){ aList.innerHTML = `<div class="muted">لا توجد عناصر — أضف ملفات صوتية.</div>`; return; } aLib.forEach((item,i)=>{ const el=document.createElement('div'); el.style.cssText='display:flex;gap:8px;align-items:center;padding:8px;border:1px solid #1f2937;border-radius:10px;margin-top:4px;background:#0b1220'; if(i===aIndex) el.style.outline='2px solid #22d3ee'; el.innerHTML=`🎵 <div style="flex:1">${item.name}</div><button data-i="${i}" class="pill">حذف</button>`; el.onclick=(ev)=>{ if(ev.target.tagName==='BUTTON'){ aLib.splice(i,1); if(aIndex>=aLib.length) aIndex=aLib.length-1; renderAList(); return; } aIndex=i; playAudio(); }; aList.appendChild(el); }); }
  function loadAudioMeta(i){ return new Promise(res=>{ const t=new Audio(aLib[i].url); t.addEventListener('loadedmetadata',()=>{aLib[i].dur=t.duration; res();},{once:true}); t.src=aLib[i].url;}); }
  async function addAudioFiles(files){ for(const f of files){ const url=URL.createObjectURL(f); aLib.push({name:f.name,url}); try{await loadAudioMeta(aLib.length-1);}catch{} } if(aIndex===-1&&aLib.length>0){aIndex=0;} renderAList(); updateANow(); }
  function updateANow(){ if(aIndex<0||!aLib[aIndex]){aNow.textContent='لا يوجد ملف مُشغّل'; aSeek.value=0; aCur.textContent='0:00'; aDur.textContent='0:00'; return} const it=aLib[aIndex]; aNow.textContent=`يتم تشغيل: ${it.name}`; }
  function playAudio(){ if(aIndex<0||!aLib[aIndex]) return; audio.src=aLib[aIndex].url; audio.play().catch(()=>{}); updateANow(); renderAList(); }
  function nextAudio(){ if(aLib.length===0) return; if(aShuffle){ if(aLib.length===1) return playAudio(); let ni=aIndex; while(ni===aIndex) ni=Math.random()*aLib.length|0; aIndex=ni; } else { if(aIndex<aLib.length-1) aIndex++; else if(aRepeat==='all') aIndex=0; else return; } playAudio(); }
  function prevAudio(){ if(aLib.length===0) return; aIndex=(aIndex>0)?aIndex-1:aLib.length-1; playAudio(); }
  audio.addEventListener('timeupdate',()=>{ if(!isFinite(audio.duration)) return; aSeek.max=Math.floor(audio.duration)||100; aSeek.value=Math.floor(audio.currentTime)||0; aCur.textContent=formatTime(audio.currentTime); aDur.textContent=formatTime(audio.duration); });
  aSeek.addEventListener('input',()=>{ audio.currentTime=+aSeek.value; });
  aVol.addEventListener('input',()=>{ audio.volume=+aVol.value; });
  aMute.addEventListener('click',()=>{ aMuted=!aMuted; audio.muted=aMuted; aMute.textContent=aMuted?'🔊 إلغاء الكتم':'🔈 كتم'; });
  aRate.addEventListener('change',()=>{ audio.playbackRate=+aRate.value; });
  audio.addEventListener('ended',()=>{ if(aRepeat==='one'){ playAudio(); } else if(aAutoplay){ nextAudio(); } });
  $('#aPrev').addEventListener('click',prevAudio); $('#aNext').addEventListener('click',nextAudio); $('#aPlay').addEventListener('click',()=>audio.play()); $('#aPause').addEventListener('click',()=>audio.pause());
  $('#aShuffle').addEventListener('click',()=>{ aShuffle=!aShuffle; $('#aShuffle').textContent=`🔀 عشوائي: ${aShuffle?'تشغيل':'إيقاف'}`; });
  $('#aRepeat').addEventListener('click',()=>{ aRepeat=aRepeat==='none'?'one':aRepeat==='one'?'all':'none'; $('#aRepeat').textContent=`🔁 تكرار: ${aRepeat==='none'?'لا':aRepeat==='one'?'واحد':'الكل'}`; });
  $('#aAutoplay').addEventListener('click',()=>{ aAutoplay=!aAutoplay; $('#aAutoplay').textContent=`🔄 تلقائي: ${aAutoplay?'تشغيل':'إيقاف'}`; });
  aFiles.addEventListener('change',e=> addAudioFiles(e.target.files));
  ;['dragenter','dragover'].forEach(ev=> aDrop.addEventListener(ev,(e)=>{e.preventDefault(); aDrop.classList.add('drag');}));
  ;['dragleave','drop'].forEach(ev=> aDrop.addEventListener(ev,(e)=>{e.preventDefault(); aDrop.classList.remove('drag');}));
  aDrop.addEventListener('drop',(e)=>{ const files=[...e.dataTransfer.files].filter(f=>f.type.startsWith('audio/')); if(files.length) addAudioFiles(files); });
  $('#aClear').addEventListener('click',()=>{ aLib=[]; aIndex=-1; renderAList(); updateANow(); });
  $('#aExport').addEventListener('click',()=>{ const data=JSON.stringify(aLib.map(x=>({name:x.name})),null,2); const blob=new Blob([data],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='audio-list.json'; a.click(); });
  $('#aImport').addEventListener('change',(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); if(Array.isArray(arr)){ aLib=[...aLib,...arr.map(x=>({name:x.name||'مقطع',url:''}))]; renderAList(); } }catch{ alert('ملف غير صالح'); } }; r.readAsText(f); });

  // ===== MEDIA: Video =====
  const videoEl=$('#video'), vFiles=$('#vFiles'), vList=$('#vList'), vNow=$('#vNow');
  const vSeek=$('#vSeek'), vCur=$('#vCur'), vDur=$('#vDur');
  const vVol=$('#vVol'), vMute=$('#vMute'), vRate=$('#vRate');
  const vDrop=$('#vDrop');
  let vLib=[], vIndex=-1, vShuffle=false, vRepeat='none', vAutoplay=true, vMuted=false;
  function renderVList(){ vList.innerHTML=''; if(vLib.length===0){ vList.innerHTML=`<div class='muted'>لا توجد عناصر — أضف ملفات فيديو.</div>`; return; } vLib.forEach((it,i)=>{ const el=document.createElement('div'); el.style.cssText='display:flex;gap:8px;align-items:center;padding:8px;border:1px solid #1f2937;border-radius:10px;margin-top:4px;background:#0b1220'; if(i===vIndex) el.style.outline='2px solid #22d3ee'; el.innerHTML=`🎬 <div style="flex:1">${it.name}</div><button class="pill" data-i="${i}">حذف</button>`; el.onclick=(ev)=>{ if(ev.target.tagName==='BUTTON'){ vLib.splice(i,1); if(vIndex>=vLib.length) vIndex=vLib.length-1; renderVList(); return; } vIndex=i; playVideo(); }; vList.appendChild(el); }); }
  function addVideoFiles(files){ for(const f of files){ vLib.push({name:f.name,url:URL.createObjectURL(f)}); } if(vIndex===-1&&vLib.length>0) vIndex=0; renderVList(); updateVNow(); }
  function updateVNow(){ if(vIndex<0||!vLib[vIndex]){vNow.textContent='لا يوجد ملف مُشغّل'; vSeek.value=0; vCur.textContent='0:00'; vDur.textContent='0:00'; return} vNow.textContent=`يتم تشغيل: ${vLib[vIndex].name}`; }
  function playVideo(){ if(vIndex<0||!vLib[vIndex])return; videoEl.src=vLib[vIndex].url; videoEl.play().catch(()=>{}); updateVNow(); renderVList(); }
  function nextVideo(){ if(vLib.length===0) return; if(vShuffle){ if(vLib.length===1) return playVideo(); let ni=vIndex; while(ni===vIndex) ni=Math.random()*vLib.length|0; vIndex=ni; } else { if(vIndex<vLib.length-1) vIndex++; else if(vRepeat==='all') vIndex=0; else return; } playVideo(); }
  function prevVideo(){ if(vLib.length===0) return; vIndex=(vIndex>0)?vIndex-1:vLib.length-1; playVideo(); }
  videoEl.addEventListener('timeupdate',()=>{ if(!isFinite(videoEl.duration)) return; vSeek.max=Math.floor(videoEl.duration)||100; vSeek.value=Math.floor(videoEl.currentTime)||0; vCur.textContent=formatTime(videoEl.currentTime); vDur.textContent=formatTime(videoEl.duration); });
  vSeek.addEventListener('input',()=>{ videoEl.currentTime=+vSeek.value; });
  vVol.addEventListener('input',()=>{ videoEl.volume=+vVol.value; });
  vMute.addEventListener('click',()=>{ vMuted=!vMuted; videoEl.muted=vMuted; vMute.textContent=vMuted?'🔊 إلغاء الكتم':'🔈 كتم'; });
  vRate.addEventListener('change',()=>{ videoEl.playbackRate=+vRate.value; });
  videoEl.addEventListener('ended',()=>{ if(vRepeat==='one'){ playVideo(); } else if(vAutoplay){ nextVideo(); } });
  $('#vPrev').addEventListener('click',prevVideo); $('#vNext').addEventListener('click',nextVideo); $('#vPlay').addEventListener('click',()=>videoEl.play()); $('#vPause').addEventListener('click',()=>videoEl.pause());
  $('#vShuffle').addEventListener('click',()=>{ vShuffle=!vShuffle; $('#vShuffle').textContent=`🔀 عشوائي: ${vShuffle?'تشغيل':'إيقاف'}`; });
  $('#vRepeat').addEventListener('click',()=>{ vRepeat=vRepeat==='none'?'one':vRepeat==='one'?'all':'none'; $('#vRepeat').textContent=`🔁 تكرار: ${vRepeat==='none'?'لا':vRepeat==='one'?'واحد':'الكل'}`; });
  $('#vAutoplay').addEventListener('click',()=>{ vAutoplay=!vAutoplay; $('#vAutoplay').textContent=`🔄 تلقائي: ${vAutoplay?'تشغيل':'إيقاف'}`; });
  $('#vPiP').addEventListener('click',async ()=>{ if(document.pictureInPictureEnabled && videoEl){ try{ if(document.pictureInPictureElement){ await document.exitPictureInPicture(); } else { await videoEl.requestPictureInPicture(); } }catch(e){ alert('PiP غير مدعوم هنا'); } } });
  $('#vShot').addEventListener('click',()=>{ try{ const c=document.createElement('canvas'); c.width=videoEl.videoWidth||1280; c.height=videoEl.videoHeight||720; const ctx=c.getContext('2d'); ctx.drawImage(videoEl,0,0,c.width,c.height); const a=document.createElement('a'); a.href=c.toDataURL('image/png'); a.download='snapshot.png'; a.click(); }catch{ alert('تعذر التقاط لقطة'); } });
  vFiles.addEventListener('change',e=> addVideoFiles(e.target.files));
  ;['dragenter','dragover'].forEach(ev=> vDrop.addEventListener(ev,(e)=>{e.preventDefault(); vDrop.classList.add('drag');}));
  ;['dragleave','drop'].forEach(ev=> vDrop.addEventListener(ev,(e)=>{e.preventDefault(); vDrop.classList.remove('drag');}));
  vDrop.addEventListener('drop',(e)=>{ const files=[...e.dataTransfer.files].filter(f=>f.type.startsWith('video/')); if(files.length) addVideoFiles(files); });
  $('#vClear').addEventListener('click',()=>{ vLib=[]; vIndex=-1; renderVList(); updateVNow(); });
  $('#vExport').addEventListener('click',()=>{ const data=JSON.stringify(vLib.map(x=>({name:x.name})),null,2); const blob=new Blob([data],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='video-list.json'; a.click(); });
  $('#vImport').addEventListener('change',(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); if(Array.isArray(arr)){ vLib=[...vLib,...arr.map(x=>({name:x.name||'فيديو',url:''}))]; renderVList(); } }catch{ alert('ملف غير صالح'); } }; r.readAsText(f); });
  </script>
<script>
// ===== أفلام/مسلسلات — نسخة خفيفة بلا تعقيد =====
const movieCats={ 'egypt':'أفلام مصرية','horror':'أفلام رعب','foreign':'أفلام أجنبي','action':'أفلام أكشن','arab-series':'مسلسلات عربية وخليجية','anime':'كرتون وأنمي' };
const catWrap=document.querySelector('#movies-cat'),catTitleEl=document.querySelector('#catTitle'),mvTitle=document.querySelector('#mvTitle');
const mvVideo=document.querySelector('#mvVideo'),mvFrame=document.querySelector('#mvFrame'),mvRate=document.querySelector('#mvRate');
const mvSubSel=document.querySelector('#mvSubSel');
const mvCast=document.querySelector('#mvCast');
const mvNextBox=document.querySelector('#mvNextBox');
const mvNextCount=document.querySelector('#mvNextCount');
const mvNextName=document.querySelector('#mvNextName');
const mvNextPlay=document.querySelector('#mvNextPlay');
const mvNextCancel=document.querySelector('#mvNextCancel');
const grid=document.querySelector('#grid'),rowCont=document.querySelector('#row-continue');
const randomBtn=document.querySelector('#randomPlay');
const fSearch=document.querySelector('#fSearch'),fYear=document.querySelector('#fYear'),fGenre=document.querySelector('#fGenre'),fCountry=document.querySelector('#fCountry'),fRating=document.querySelector('#fRating'),fSort=document.querySelector('#fSort');
const newTitle=document.querySelector('#newTitle'),newUrl=document.querySelector('#newUrl'),newPoster=document.querySelector('#newPoster'),newYear=document.querySelector('#newYear'),newGenre=document.querySelector('#newGenre'),newCountry=document.querySelector('#newCountry'),newRating=document.querySelector('#newRating'),newSeries=document.querySelector('#newSeries'),newS=document.querySelector('#newS'),newE=document.querySelector('#newE'),newSubs=document.querySelector('#newSubs');
const addItemBtn=document.querySelector('#addItem'),clearItemsBtn=document.querySelector('#clearItems'),exportBtn=document.querySelector('#exportItems'),importInp=document.querySelector('#importItems');
// Cloud controls
const syncProviderSel=document.querySelector('#syncProvider');
const supaUrlInp=document.querySelector('#supaUrl');
const supaKeyInp=document.querySelector('#supaKey');
const syncUserInp=document.querySelector('#syncUser');
const syncPushBtn=document.querySelector('#syncPush');
const syncPullBtn=document.querySelector('#syncPull');
const syncStatus=document.querySelector('#syncStatus');


const storeKey=(cat)=>`lib:${cat}`;
const loadLib=(cat)=>{try{return JSON.parse(localStorage.getItem(storeKey(cat))||'[]')}catch{return []}};
const saveLib=(cat,data)=> localStorage.setItem(storeKey(cat),JSON.stringify(data));
const resumeKey=(cat,id)=>`resume:${cat}:${id}`;
const loadResume=(cat,id)=>{try{return JSON.parse(localStorage.getItem(resumeKey(cat,id))||'null')}catch{return null}};
const saveResume=(cat,id,sec,dur)=> localStorage.setItem(resumeKey(cat,id),JSON.stringify({t:sec,d:dur,at:Date.now()}));

function toEmbed(url){try{const u=new URL(url);const host=u.hostname.replace('www.','');if(host.includes('youtube.com')){const id=u.searchParams.get('v');if(id) return `https://www.youtube.com/embed/${id}`;const p=u.pathname.split('/').filter(Boolean);if(p[0]==='shorts'&&p[1]) return `https://www.youtube.com/embed/${p[1]}`;}if(host==='youtu.be'){const id=u.pathname.slice(1);if(id) return `https://www.youtube.com/embed/${id}`;}if(host.includes('vimeo.com')){const id=u.pathname.split('/').filter(Boolean)[0];if(id) return `https://player.vimeo.com/video/${id}`;}if(host.includes('dailymotion.com')){const id=u.pathname.split('/').pop();if(id) return `https://www.dailymotion.com/embed/video/${id}`;}if(url.endsWith('.m3u8')){return null;} }catch(e){}return null}
function isHls(u){try{return new URL(u).pathname.toLowerCase().endsWith('.m3u8')}catch(e){return (u||'').toLowerCase().endsWith('.m3u8')}}
function hasVideoExt(u){try{const p=new URL(u).pathname.toLowerCase();return ['.mp4','.webm','.ogg','.m3u8'].some(ext=>p.endsWith(ext));}catch(e){const x=(u||'').toLowerCase();return x.startsWith('blob:')||x.endsWith('.mp4')||x.endsWith('.webm')||x.endsWith('.ogg')||x.endsWith('.m3u8');}}
function hasVideoExt(u){try{const p=new URL(u).pathname.toLowerCase();return ['.mp4','.webm','.ogg'].some(ext=>p.endsWith(ext));}catch(e){const x=u.toLowerCase();return x.startsWith('blob:')||x.endsWith('.mp4')||x.endsWith('.webm')||x.endsWith('.ogg');}}

function playItem(cat,item){mvTitle.textContent=item.title||'—';const emb=item.url?toEmbed(item.url):null;mvFrame.classList.remove('active');mvVideo.classList.remove('active');mvVideo.pause?.();if(item.url&&hasVideoExt(item.url)){mvFrame.src='';mvVideo.src=item.url;mvVideo.classList.add('active');mvVideo.play().catch(()=>{});document.querySelector('#mvSubs').textContent='';}else if(item.url&&emb){mvVideo.src='';mvFrame.src=emb;mvFrame.classList.add('active');document.querySelector('#mvSubs').textContent='';}else if(item.url){mvVideo.src='';mvFrame.src=item.url;mvFrame.classList.add('active');document.querySelector('#mvSubs').textContent='';}
let lastSave=0;mvVideo.onTimeUpdate=null;mvVideo.addEventListener('timeupdate',()=>{const now=Date.now();if(now-lastSave>3000){saveResume(cat,item.id,mvVideo.currentTime||0,mvVideo.duration||0);lastSave=now;}});
mvVideo.addEventListener('ended',()=>{if(item.series){const lib=loadLib(cat).filter(x=>x.series===item.series).sort((a,b)=>(a.s-b.s)||(a.e-b.e));const idx=lib.findIndex(x=>x.id===item.id);const next=lib[idx+1];if(next){playItem(cat,next);return;}}});
window.onkeydown=(e)=>{if(!document.querySelector('#page-movies').classList.contains('active'))return;if(['INPUT','TEXTAREA','SELECT'].includes(document.activeElement?.tagName))return;if(e.key===' '){e.preventDefault();mvVideo.paused?mvVideo.play():mvVideo.pause();}if(e.key==='ArrowRight'){mvVideo.currentTime+=5;}if(e.key==='ArrowLeft'){mvVideo.currentTime-=5;}if(e.key.toLowerCase()==='m'){mvVideo.muted=!mvVideo.muted;}if(e.key.toLowerCase()==='f'){if(document.fullscreenElement){document.exitFullscreen();}else{mvVideo.requestFullscreen?.();}}};}

function renderContinue(cat){
  rowCont.innerHTML='';
  const lib=loadLib(cat);
  const withProg=lib.map(it=>({it,rs:loadResume(cat,it.id)})).filter(x=>x.rs&&x.rs.d>0);
  withProg.sort((a,b)=>b.rs.at-a.rs.at);
  for(const {it,rs} of withProg.slice(0,14)){
    const card=document.createElement('div');
    card.className='card';
    const img=document.createElement('img');
    img.loading='lazy';
    img.classList.add('skeleton');
    img.addEventListener('load',()=>img.classList.remove('skeleton'));
    img.src= it.poster||`https://dummyimage.com/480x270/0b1220/94a3b8.png&text=${encodeURIComponent(it.title)}`;
    const p=document.createElement('div'); p.className='p';
    const t=document.createElement('strong'); t.textContent=it.title;
    const info=document.createElement('div'); info.className='muted'; info.textContent=`استكمال من ${formatTime(rs.t||0)} / ${formatTime(rs.d||0)}`;
    const prog=document.createElement('div'); prog.className='progress'; const bar=document.createElement('span'); bar.style.width=(100*rs.t/rs.d).toFixed(1)+'%'; prog.appendChild(bar);
    const btn=document.createElement('button'); btn.className='btn-acc btn'; btn.textContent='▶️ تابع من هنا'; btn.onclick=(ev)=>{ ev.stopPropagation(); playItem(cat,it); const jump=()=>{ try{ mvVideo.currentTime=rs.t||0; }catch{} mvVideo.removeEventListener('loadedmetadata',jump); }; mvVideo.addEventListener('loadedmetadata',jump); window.scrollTo({top:0,behavior:'smooth'}); };
    p.append(t,info,prog,btn); card.append(img,p);
    card.onclick=()=> btn.click();
    rowCont.append(card);
  }
}
function filterAndSort(cat){let items=loadLib(cat);const q=(fSearch?.value||'').trim();if(q){const Fuse=window.Fuse;if(Fuse){const fuse=new Fuse(items,{keys:['title','genres','country','series'],threshold:0.4});items=fuse.search(q).map(r=>r.item);}else{const qq=q.toLowerCase();items=items.filter(x=>(x.title||'').toLowerCase().includes(qq));}}if(fYear?.value){items=items.filter(x=>String(x.year)===fYear.value);}if(fGenre?.value){items=items.filter(x=>(x.genres||[]).some(g=>g.toLowerCase()===fGenre.value.toLowerCase()));}if(fCountry?.value){items=items.filter(x=>(x.country||'').toUpperCase()===fCountry.value.toUpperCase());}if(fRating?.value){items=items.filter(x=>(+x.rating||0)>=+fRating.value);}const sort=fSort?.value||'new';if(sort==='new'){items.sort((a,b)=>(b.year||0)-(a.year||0));}else if(sort==='top'){items.sort((a,b)=>(b.rating||0)-(a.rating||0));}else if(sort==='views'){items.sort((a,b)=>(b.views||0)-(a.views||0));}else if(sort==='az'){items.sort((a,b)=>(a.title||'').localeCompare(b.title||''));}return items;}

function renderGrid(cat){
  grid.innerHTML='';
  const items=filterAndSort(cat);
  if(items.length===0){ grid.innerHTML=`<div class='muted'>لا توجد عناصر — أضف عناصر من الأعلى.</div>`; return; }
  for(const it of items){
    const card=document.createElement('div'); card.className='card';
    const img=document.createElement('img'); img.loading='lazy'; img.classList.add('skeleton'); img.addEventListener('load',()=>img.classList.remove('skeleton')); img.alt=it.title; img.src= it.poster||`https://dummyimage.com/480x270/0b1220/94a3b8.png&text=${encodeURIComponent(it.title)}`;
    const p=document.createElement('div'); p.className='p';
    const title=document.createElement('strong'); title.textContent=it.title;
    const meta=document.createElement('div'); meta.className='muted'; meta.textContent=[it.year,(it.genres||[]).join(' • '),it.country, (it.rating?`⭐ ${it.rating}`:'')].filter(Boolean).join(' — ');
    const row=document.createElement('div'); row.style.cssText='display:flex;gap:8px;flex-wrap:wrap;margin-top:6px';
    const play=document.createElement('button'); play.className='btn-acc btn'; play.textContent='▶️ تشغيل هنا'; play.onclick=()=>{ it.views=(it.views||0)+1; saveLib(cat,loadLib(cat).map(x=>x.id===it.id?{...x,views:it.views}:x)); playItem(cat,it); window.scrollTo({top:0,behavior:'smooth'}); };
    const fav=document.createElement('button'); fav.className='btn'; fav.textContent= it.fav?'✅ بالمفضلة':'⭐ مفضلة'; fav.onclick=()=>{ it.fav=!it.fav; fav.textContent= it.fav?'✅ بالمفضلة':'⭐ مفضلة'; saveLib(cat,loadLib(cat).map(x=>x.id===it.id?it:x)); };
    const tmdbBtn=document.createElement('button'); tmdbBtn.className='btn'; tmdbBtn.textContent='TMDB'; tmdbBtn.title='جلب بيانات تلقائيًا'; tmdbBtn.onclick=async()=>{ try{ const d= await window.tmdbLookup(it.title, it.year); if(!d){ alert('لا نتائج من TMDB'); return; } it.poster = d.poster || it.poster; it.rating = d.rating || it.rating; it.year = it.year || d.year; it.backdrop = d.backdrop || it.backdrop; saveLib(cat,loadLib(cat).map(x=>x.id===it.id?it:x)); renderGrid(cat); }catch(e){ alert('فشل الاتصال بـ TMDB'); } };
    const del=document.createElement('button'); del.className='btn-danger btn'; del.textContent='حذف'; del.onclick=()=>{ const lib=loadLib(cat).filter(x=>x.id!==it.id); saveLib(cat,lib); renderGrid(cat); };
    row.append(play,fav,tmdbBtn,del); p.append(title,meta,row); card.append(img,p); grid.append(card);
  }
}

function bindCat(cat){['input','change'].forEach(ev=>{[fSearch,fYear,fGenre,fCountry,fRating,fSort].forEach(el=> el?.addEventListener(ev,()=>renderGrid(cat)));});addItemBtn.onclick=()=>addItem(cat);clearItemsBtn.onclick=()=>{if(confirm('مسح كل عناصر هذا التصنيف؟')){saveLib(cat,[]);renderGrid(cat);renderContinue(cat);}};exportBtn.onclick=()=>{const blob=new Blob([JSON.stringify(loadLib(cat),null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`${cat}-library.json`;a.click();};importInp.onchange=(e)=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{const arr=JSON.parse(r.result);if(Array.isArray(arr)){saveLib(cat,arr);renderGrid(cat);renderContinue(cat);}}catch{alert('ملف غير صالح');}};r.readAsText(f);};randomBtn.onclick=()=>{const items=loadLib(cat);if(!items.length)return;const it=items[Math.random()*items.length|0];playItem(cat,it);window.scrollTo({top:0,behavior:'smooth'});};mvRate.onchange=()=>{mvVideo.playbackRate=+mvRate.value;};document.querySelector('#mvPiP').onclick=async()=>{if(document.pictureInPictureEnabled&&mvVideo.classList.contains('active')){try{if(document.pictureInPictureElement){await document.exitPictureInPicture();}else{await mvVideo.requestPictureInPicture();}}catch{}}};document.querySelector('#mvFS').onclick=()=>{if(document.fullscreenElement){document.exitFullscreen();}else{mvVideo.requestFullscreen?.();}};document.querySelector('#mvShare').onclick=async()=>{const itTitle=mvTitle.textContent;if(navigator.share){try{await navigator.share({title:'مشاهدة: '+itTitle,text:itTitle,url:location.href});}catch{}}else{navigator.clipboard.writeText(location.href);alert('تم نسخ الرابط.');}}}

let currentCat='';
function ensureSeedFor(cat){ const samples={ 'action':[ {title:'Big Buck Bunny (عيّنة)',url:'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',poster:'https://dummyimage.com/480x270/111827/94a3b8.png&text=Big+Buck+Bunny',year:2008,genres:['Action'],country:'US',rating:7.2} ], 'horror':[ {title:'Horror Trailer (YouTube)',url:'https://www.youtube.com/watch?v=6dSKUoV0SNI',poster:'https://dummyimage.com/480x270/111827/ef4444.png&text=Horror+Trailer',year:2020,genres:['Horror'],country:'US',rating:8} ], 'foreign':[ {title:'Sintel (عيّنة)',url:'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4',poster:'https://dummyimage.com/480x270/111827/94a3b8.png&text=Sintel',year:2010,genres:['Drama'],country:'NL',rating:7.0} ], 'egypt':[ {title:'إعلان (YouTube)',url:'https://www.youtube.com/watch?v=ysz5S6PUM-U',poster:'https://dummyimage.com/480x270/111827/94a3b8.png&text=Egypt+Movie',year:2024,genres:['Drama'],country:'EG',rating:7.5} ], 'arab-series':[ {title:'حلقة 1',url:'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4',poster:'https://dummyimage.com/480x270/111827/94a3b8.png&text=Series+S1E1',year:2021,genres:['Drama'],country:'SA',rating:8.1,series:'مسلسل تجريبي',s:1,e:1}, {title:'حلقة 2',url:'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4',poster:'https://dummyimage.com/480x270/111827/94a3b8.png&text=Series+S1E2',year:2021,genres:['Drama'],country:'SA',rating:8.1,series:'مسلسل تجريبي',s:1,e:2} ], 'anime':[ {title:'Anime Trailer (YouTube)',url:'https://www.youtube.com/watch?v=rPUP9FvZQvQ',poster:'https://dummyimage.com/480x270/111827/94a3b8.png&text=Anime+Trailer',year:2019,genres:['Anime'],country:'JP',rating:8.6} ] };
  const lib=loadLib(cat); if(!lib.length){ saveLib(cat, samples[cat]||[]); } }
function addItem(cat){const item={id:Date.now()+Math.random().toString(36).slice(2),title:newTitle.value.trim(),url:newUrl.value.trim(),poster:newPoster.value.trim()||'',year:+(newYear.value||'')||'',genres:(newGenre.value||'').split(',').map(s=>s.trim()).filter(Boolean),country:(newCountry.value||'').trim(),rating:+(newRating.value||'')||'',series:(newSeries.value||'').trim(),s:+(newS.value||'')||'',e:+(newE.value||'')||'',subsRaw:(newSubs.value||''), subs:[]};if(!item.title){newTitle.focus();return;}const lib=loadLib(currentCat);lib.push(item);saveLib(currentCat,lib);[newTitle,newUrl,newPoster,newYear,newGenre,newCountry,newRating,newSeries,newS,newE,newSubs].forEach(i=>i.value='');renderGrid(currentCat);}
function openCat(cat){ if(!movieCats[cat])return; document.querySelector('#movies-home').style.display='none'; catWrap.style.display='block'; currentCat=cat; catWrap.setAttribute('data-cat',cat); catTitleEl.textContent=movieCats[cat]; ensureSeedFor(cat); bindCat(cat); renderGrid(cat); renderContinue(cat); } 
function closeCat(){document.querySelector('#movies-home').style.display='block';catWrap.style.display='none';currentCat='';}

(function seedOnce(){if(localStorage.getItem('seed:v1-lite'))return;localStorage.setItem('seed:v1-lite','1');const samples={'action':[ {title:'Big Buck Bunny (عيّنة)',url:'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',poster:'https://dummyimage.com/480x270/111827/94a3b8.png&text=Big+Buck+Bunny',year:2008,genres:['Action'],country:'US',rating:7.2} ],'horror':[ {title:'Horror Trailer (YouTube)',url:'https://www.youtube.com/watch?v=6dSKUoV0SNI',poster:'https://dummyimage.com/480x270/111827/ef4444.png&text=Horror+Trailer',year:2020,genres:['Horror'],country:'US',rating:8} ],'foreign':[ {title:'Sintel (عيّنة)',url:'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/Sintel.mp4',poster:'https://dummyimage.com/480x270/111827/94a3b8.png&text=Sintel',year:2010,genres:['Drama'],country:'NL',rating:7.0} ],'egypt':[ {title:'إعلان (YouTube)',url:'https://www.youtube.com/watch?v=ysz5S6PUM-U',poster:'https://dummyimage.com/480x270/111827/94a3b8.png&text=Egypt+Movie',year:2024,genres:['Drama'],country:'EG',rating:7.5} ],'arab-series':[ {title:'حلقة 1',url:'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4',poster:'https://dummyimage.com/480x270/111827/94a3b8.png&text=Series+S1E1',year:2021,genres:['Drama'],country:'SA',rating:8.1,series:'مسلسل تجريبي',s:1,e:1}, {title:'حلقة 2',url:'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4',poster:'https://dummyimage.com/480x270/111827/94a3b8.png&text=Series+S1E2',year:2021,genres:['Drama'],country:'SA',rating:8.1,series:'مسلسل تجريبي',s:1,e:2} ],'anime':[ {title:'Anime Trailer (YouTube)',url:'https://www.youtube.com/watch?v=rPUP9FvZQvQ',poster:'https://dummyimage.com/480x270/111827/94a3b8.png&text=Anime+Trailer',year:2019,genres:['Anime'],country:'JP',rating:8.6} ]};
for(const k of Object.keys(samples)){const cur=loadLib(k);if(cur.length===0)saveLib(k,samples[k]);}})();

// === Cloud Sync Utilities ===
const SYNC_NS='sync:';
function getSyncCfg(){
  return {
    provider: localStorage.getItem(SYNC_NS+'provider')||'local',
    supaUrl: localStorage.getItem(SYNC_NS+'supa:url')||'',
    supaKey: localStorage.getItem(SYNC_NS+'supa:key')||'',
    user: localStorage.getItem(SYNC_NS+'user')||''
  };
}
function setSyncCfg(cfg){
  localStorage.setItem(SYNC_NS+'provider', cfg.provider||'local');
  localStorage.setItem(SYNC_NS+'supa:url', cfg.supaUrl||'');
  localStorage.setItem(SYNC_NS+'supa:key', cfg.supaKey||'');
  localStorage.setItem(SYNC_NS+'user', cfg.user||'');
}
function uiSyncCfgApply(){
  const cfg=getSyncCfg();
  if(syncProviderSel){ syncProviderSel.value=cfg.provider; }
  if(supaUrlInp){ supaUrlInp.value=cfg.supaUrl; supaUrlInp.style.display= cfg.provider==='supabase'?'block':'none'; }
  if(supaKeyInp){ supaKeyInp.value=cfg.supaKey; supaKeyInp.style.display= cfg.provider==='supabase'?'block':'none'; }
  if(syncUserInp){ syncUserInp.value=cfg.user||''; }
}
function collectState(){
  const cats=Object.keys(movieCats); const state={favorites:{}, resume:{}};
  for(const cat of cats){
    const lib=loadLib(cat);
    state.favorites[cat]=lib.filter(x=>x.fav).map(x=>x.id);
    const res={};
    for(const it of lib){ const r=loadResume(cat,it.id); if(r&&r.t){ res[it.id]=r; } }
    state.resume[cat]=res;
  }
  state.updated=Date.now(); return state;
}
function applyState(state){ try{
  const cats=Object.keys(movieCats);
  for(const cat of cats){
    let lib=loadLib(cat);
    const favIds=(state.favorites?.[cat])||[];
    lib=lib.map(x=> ({...x, fav: favIds.includes(x.id)}));
    saveLib(cat,lib);
    const resObj=state.resume?.[cat]||{};
    for(const [id,rs] of Object.entries(resObj)){ saveResume(cat,id,rs.t||0,rs.d||0); }
  }
  if(currentCat){ renderGrid(currentCat); renderContinue(currentCat); }
 }catch(e){ console.warn('applyState failed',e); }
}
async function supaPush(cfg){
  const st=collectState(); const url=(cfg.supaUrl||'').replace(/\/$/,'')+"/rest/v1/media_state?on_conflict=user_id";
  const headers={ 'apikey':cfg.supaKey, 'Authorization':'Bearer '+cfg.supaKey, 'Content-Type':'application/json', 'Prefer':'resolution=merge-duplicates' };
  const row={ user_id: cfg.user||'guest', data: st, updated_at: new Date().toISOString() };
  const r=await fetch(url,{method:'POST',headers,body:JSON.stringify([row])}); if(!r.ok) throw new Error('HTTP '+r.status);
  return true;
}
async function supaPull(cfg){
  const base=(cfg.supaUrl||'').replace(/\/$/,'');
  const url= base+"/rest/v1/media_state?user_id=eq."+encodeURIComponent(cfg.user||'guest')+"&select=data,updated_at&limit=1";
  const headers={ 'apikey':cfg.supaKey, 'Authorization':'Bearer '+cfg.supaKey };
  const r=await fetch(url,{headers}); if(!r.ok) throw new Error('HTTP '+r.status);
  const arr=await r.json(); if(!arr.length) throw new Error('لا توجد بيانات محفوظة');
  return arr[0].data;
}
function setupCloudUI(){
  if(!syncProviderSel) return;
  uiSyncCfgApply();
  syncProviderSel.addEventListener('change',()=>{ setSyncCfg({provider:syncProviderSel.value, supaUrl:supaUrlInp.value, supaKey:supaKeyInp.value, user:syncUserInp.value}); uiSyncCfgApply(); });
  [supaUrlInp,supaKeyInp,syncUserInp].forEach(inp=> inp?.addEventListener('input',()=>{ setSyncCfg({provider:syncProviderSel.value, supaUrl:supaUrlInp.value, supaKey:supaKeyInp.value, user:syncUserInp.value}); }));
  syncPushBtn?.addEventListener('click', async ()=>{ const cfg=getSyncCfg(); try{ if(cfg.provider!=='supabase') { const data=collectState(); const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='media-state.json'; a.click(); syncStatus.textContent='↗️ تم تصدير ملف الحالة (محلي)'; return; } syncStatus.textContent='⏫ جاري الرفع...'; await supaPush(cfg); syncStatus.textContent='✅ تم الرفع إلى Supabase'; }catch(e){ syncStatus.textContent='❌ فشل الرفع: '+e.message; }});
  syncPullBtn?.addEventListener('click', async ()=>{ const cfg=getSyncCfg(); try{ if(cfg.provider!=='supabase'){ const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json'; inp.onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const st=JSON.parse(r.result); applyState(st); syncStatus.textContent='✅ تم تحميل الملف وتطبيق الحالة'; }catch{ syncStatus.textContent='❌ ملف غير صالح'; } }; r.readAsText(f); }; inp.click(); return; } syncStatus.textContent='⏬ جاري التحميل...'; const st=await supaPull(cfg); applyState(st); syncStatus.textContent='✅ تم التحميل من Supabase'; }catch(e){ syncStatus.textContent='❌ فشل التحميل: '+e.message; }});
}
setupCloudUI();

// فعّل الراوتر بعد تعريف الدوال
showPageByHash();
</script>
</body>
<script>
// تفعيل تيم فاتح/داكن + تكبير/تصغير الخط (إمكانية الوصول)
(function(){
  const themeBtn=document.getElementById('themeToggle');
  const plus=document.getElementById('fontPlus');
  const minus=document.getElementById('fontMinus');
  const applyPrefs=()=>{ const th=localStorage.getItem('pref:theme')||'dark'; document.body.dataset.theme= th==='light'?'light':''; const fs=+(localStorage.getItem('pref:font')||100); document.documentElement.style.fontSize=fs+'%'; };
  applyPrefs();
  themeBtn?.addEventListener('click',()=>{ const cur=document.body.dataset.theme==='light'?'light':'dark'; const next= cur==='light'?'dark':'light'; localStorage.setItem('pref:theme',next); applyPrefs(); });
  plus?.addEventListener('click',()=>{ const fs=Math.min(130, +(localStorage.getItem('pref:font')||100)+5); localStorage.setItem('pref:font',fs); applyPrefs(); });
  minus?.addEventListener('click',()=>{ const fs=Math.max(85, +(localStorage.getItem('pref:font')||100)-5); localStorage.setItem('pref:font',fs); applyPrefs(); });
})();
</script>
<script>
// مشغّل محسّن: HLS بسيط + ترجمات VTT + اختصارات + التالي 5ث + Cast (خفيف)
(function(){
  if(!window.mvVideo) return;
  const v = mvVideo;
  let hls=null; function destroy(){ if(hls){ try{hls.destroy();}catch{} hls=null; } }
  function isHls(u){ try{return new URL(u).pathname.toLowerCase().endsWith('.m3u8');}catch(e){ return (u||'').toLowerCase().endsWith('.m3u8'); } }
  window.playItem = async function(cat,item){
    mvTitle.textContent=item.title||'—';
    mvFrame.classList.remove('active'); v.classList.remove('active'); try{v.pause();}catch{}
    destroy(); if(window.mvNextBox) mvNextBox.classList.remove('show');
    const url=(item.url||'');
    const isFile = url.startsWith('blob:') || url.toLowerCase().endsWith('.mp4') || url.toLowerCase().endsWith('.webm') || url.toLowerCase().endsWith('.ogg') || url.toLowerCase().endsWith('.m3u8');
    if(url && isFile){
      mvFrame.src='';
      if(isHls(url) && window.Hls && window.Hls.isSupported()){ try{ hls=new Hls(); hls.loadSource(url); hls.attachMedia(v);}catch{} } else { v.src=url; }
      v.classList.add('active'); v.play().catch(()=>{});
    } else if(url){
      v.src=''; const emb = (window.toEmbed?toEmbed(url):null) || url; mvFrame.src=emb; mvFrame.classList.add('active');
    }
    // ترجمات (VTT فقط هنا)
    ;[...v.querySelectorAll('track')].forEach(t=>t.remove());
    if(window.mvSubSel){ mvSubSel.innerHTML='<option value="off">إيقاف</option>'; }
    const raw=item.subsRaw||''; if(raw){ const parts=raw.split(';').map(x=>x.trim()).filter(Boolean); for(const p of parts){ const seg=p.split('|'); const surl=(seg[0]||'').trim(); const code=(seg[1]||'').trim(); if(!surl) continue; const tr=document.createElement('track'); tr.kind='subtitles'; tr.label=code||'ترجمة'; tr.srclang=code||''; tr.src=surl; v.appendChild(tr); if(window.mvSubSel){ const opt=document.createElement('option'); opt.value=code||tr.label; opt.textContent=tr.label; mvSubSel.appendChild(opt);} } const tt=v.textTracks; for(let i=0;i<tt.length;i++){ tt[i].mode='disabled'; } }
    if(window.mvSubSel){ mvSubSel.onchange=()=>{ const code=mvSubSel.value; const tt=v.textTracks; for(let i=0;i<tt.length;i++){ tt[i].mode=(code!=='off' && (tt[i].language===code||tt[i].label===code))?'showing':'disabled'; } }; }

    // التالي 5ث
    v.onended=null; v.onended=()=>{ if(item.series){ const lib=loadLib(cat).filter(x=>x.series===item.series).sort((a,b)=>(a.s-b.s)||(a.e-b.e)); const idx=lib.findIndex(x=>x.id===item.id); const next=lib[idx+1]; if(next && window.mvNextBox){ let s=5; mvNextName.textContent=next.title||'التالي'; mvNextCount.textContent=String(s); mvNextBox.classList.add('show'); const t=setInterval(()=>{ s--; mvNextCount.textContent=String(s); if(s<=0){ clearInterval(t); mvNextBox.classList.remove('show'); window.playItem(cat,next); } },1000); mvNextCancel.onclick=()=>{ clearInterval(t); mvNextBox.classList.remove('show'); }; mvNextPlay.onclick=()=>{ clearInterval(t); mvNextBox.classList.remove('show'); window.playItem(cat,next); }; return; } } destroy(); };

    // اختصارات
    window.onkeydown=(e)=>{ if(!document.querySelector('#page-movies').classList.contains('active'))return; if(['INPUT','TEXTAREA','SELECT'].includes(document.activeElement?.tagName))return; const k=e.key; if(k===' '||k==='k'||k==='K'){ e.preventDefault(); v.paused?v.play():v.pause(); } if(k==='ArrowRight'||k==='l'||k==='L'){ v.currentTime+= (k==='ArrowRight'?5:10); } if(k==='ArrowLeft'||k==='j'||k==='J'){ v.currentTime-= (k==='ArrowLeft'?5:10); } if(k==='ArrowUp'){ e.preventDefault(); v.volume=Math.min(1,(v.volume||0)+0.05); } if(k==='ArrowDown'){ e.preventDefault(); v.volume=Math.max(0,(v.volume||0)-0.05); } if(k===','||k==='<'){ v.playbackRate=Math.max(.25,(v.playbackRate||1)-.25); mvRate.value=String(v.playbackRate);} if(k==='.'||k==='>'){ v.playbackRate=Math.min(3,(v.playbackRate||1)+.25); mvRate.value=String(v.playbackRate);} if(k.toLowerCase()==='m'){ v.muted=!v.muted; } if(k.toLowerCase()==='f'){ if(document.fullscreenElement){ document.exitFullscreen(); } else { v.requestFullscreen?.(); } } };

    // Cast
    if(window.mvCast){ mvCast.onclick= async ()=>{ try{ if('remote' in v && v.remote && v.remote.prompt){ await v.remote.prompt(); } else { alert('خاصية Cast غير مدعومة في هذا المتصفح.'); } }catch(e){ alert('تعذر بدء الإرسال'); } } }
  };
})();
</script>
</html>
